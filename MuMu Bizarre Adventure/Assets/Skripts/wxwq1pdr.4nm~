using System.Collections;
using System.Collections.Generic;
using UnityEngine;
using UnityEngine.UI;
using UnityEngine.SceneManagement;


public class PlayerKontroller : Sounds
{
    [SerializeField]
    [Header("Controls")]
    public ControlType controlType;
    public Joystick joystick;
    public enum ControlType { PC, Android};
    public float speed;
    public float jumpForce;
    public float moveInput;
    [Header("Healths")]
    public float health;
    public int numOfHearts;
    public Image[] hearts;
    public Sprite fullHeart;
    public Sprite emptyHeart;

    public float point;
    public int numOfPoint;
    public Image[] pointImage;
    public Sprite fullPoint;
    public Sprite emptyPoint;
    [Header("Effects and Panels")]
    public GameObject panel;
    public GameObject potionEffect;
    public GameObject emptyulta;
    public GameObject[] ulta;
    public GameObject stend;
    
    private Rigidbody2D rb;

    private bool facingRight = true;

    private bool isGrounded;
    [Header("Kusha")]
    public Transform feetPos;
    public float checkRadius;
    public LayerMask whatIsGround;

    private Animator anim;
    public VectorValue pos;
    [Header("Weapons")]
    public List<GameObject> unlockedWeapons;
    public GameObject[] allWeapons;
    public Image weaponIcon;
    public Gun[] guns;
    private ScoreManager scoreM;
    private Gun gun;
    public float SpZona;
    public Transform SpPos;
    [Header("Музыка")]
    public GameObject SlavZS;
    public float zvukTime;
    public float zTime;

    [Header("Стенд")]
    public bool seroga;

    private void Start()
    {
        transform.position = pos.initialValue;
        anim = GetComponent<Animator>();
        rb = GetComponent<Rigidbody2D>();
        if (controlType == ControlType.PC)
        {
            joystick.gameObject.SetActive(false);
        }
        else if (controlType == ControlType.Android)
        {
            joystick.gameObject.SetActive(true);
        }
    }


    private void FixedUpdate()
    {
        if (point > numOfPoint)
        {
            point = numOfPoint;
        }
        if (health <= 0)
        {
            panel.SetActive(true);
        }
        if(health > 0)
        {
            panel.SetActive(false);
        }
        if(health > numOfHearts)
        {
            health = numOfHearts;
        }
        for (int i = 0; i < hearts.Length; i++)
        {
            if(i < Mathf.RoundToInt(health))
            {
                hearts[i].sprite = fullHeart;
            }
            else
            {
                hearts[i].sprite = emptyHeart;
            }
            if(i < numOfHearts)
            {
                hearts[i].enabled = true;
            }
            else
            {
                hearts[i].enabled = false;
            }
        }
        for (int i = 0; i < pointImage.Length; i++)
        {
            if (i < Mathf.RoundToInt(point))
            {
                pointImage[i].sprite = fullPoint;
            }
            else
            {
                pointImage[i].sprite = emptyPoint;
            }
            if (i < numOfPoint)
            {
                pointImage[i].enabled = true;
            }
            else
            {
                pointImage[i].enabled = false;
            }
        }
        if (controlType == ControlType.PC)
        {
            moveInput = Input.GetAxis("Horizontal");
        }
        else if(controlType == ControlType.Android)
        {
            moveInput = joystick.Horizontal;
        }
        rb.velocity = new Vector2(moveInput * speed, rb.velocity.y);
        if(facingRight == false && moveInput > 0)
        {
            Flip();
        }
        else if(facingRight == true && moveInput < 0)
        {
            Flip();
        }
        if(moveInput == 0)
        {
            anim.SetBool("isRunning", false);
        }
        else
        {
            zvukTime -= Time.deltaTime;
            anim.SetBool("isRunning", true);
            if (zvukTime <= 0)
            {
                PlaySound(1);
                zvukTime += zTime;
            }
        }
    }

    private void Update()
    {
        switch(point)
        {
            case 0:
                emptyulta.SetActive(true);
                ulta[0].SetActive(false);
                ulta[1].SetActive(false);
                break;

            case 1:
                emptyulta.SetActive(false);
                ulta[0].SetActive(true);
                ulta[1].SetActive(false);
                break;

            case 2:
                emptyulta.SetActive(false);
                ulta[1].SetActive(true);
                ulta[0].SetActive(false);
                break;
            case 3:
                emptyulta.SetActive(false);
                ulta[1].SetActive(true);
                ulta[0].SetActive(false);
                break;
        }

        if (ScoreManager.score >= 200)
        {
            point = 1;

            if (ScoreManager.score >= 800)
            {
                point = 2;

                if (ScoreManager.score >= 1200)
                {
                    point = 3;
                }
            }
        }
        else if (ScoreManager.score < 200)
        {
            point = 0;
        }
        
        float verticalMove = joystick.Vertical;
        isGrounded = Physics2D.OverlapCircle(feetPos.position, checkRadius, whatIsGround);

        if (controlType == ControlType.PC)
        {
            if (isGrounded == true && Input.GetKeyDown(KeyCode.Space))
            {
                rb.velocity = Vector2.up * jumpForce;
                anim.SetTrigger("takeOf");
            }

            if (Input.GetKeyDown(KeyCode.S))
            {
                Physics2D.IgnoreLayerCollision(9, 10, true);
                Invoke("IgnoreLayerOff", 0.5f);
            }
        }
        else if (controlType == ControlType.Android)
        {
            if (isGrounded == true && verticalMove >= .4f)
            {
                rb.velocity = Vector2.up * jumpForce;
                anim.SetTrigger("takeOf");
            }

            if (verticalMove <= -.5f)
            {
                Physics2D.IgnoreLayerCollision(9, 10, true);
                Invoke("IgnoreLayerOff", 0.5f);
            }
        }

        if(isGrounded == true)
        {
            anim.SetBool("isJumping", false);
        }
        else
        {
            anim.SetBool("isJumping", true);
        }
        

        if(Input.GetKeyDown(KeyCode.Q))
        {
            SwitchWeapon();
        }
    }

    private void Flip()
    {
        facingRight = !facingRight;
        transform.Rotate(0, 180, 0);
    }

    private void OnTriggerEnter2D(Collider2D other)
    {
        if(other.CompareTag("Potion"))
        {
            health++;
            health++;
            health++;
            health++;
            Instantiate(potionEffect, other.transform.position, Quaternion.identity);
            Destroy(other.gameObject);
        }

        else if (other.CompareTag("Weapon"))
        {
            for (int i = 0; i < allWeapons.Length; i++)
            {
                if(other.name == allWeapons[i].name)
                {
                    unlockedWeapons.Add(allWeapons[i]);

                }
            }
            SwitchWeapon();
            Destroy(other.gameObject);
        }

        if (other.CompareTag("Патроны"))
        {
            Gun.allAmmo += 30;
            Destroy(other.gameObject);
        }
    }


    public int lungeImpulse = 8000;

    public void Lunge()
    {
        if (!lockLunge)
        {
            lockLunge = true;
            Invoke("LungeLock", 2f);

            anim.StopPlayback();
            anim.Play("lunge");

            rb.velocity = new Vector2(0, 0);

            if (!facingRight) { rb.AddForce(Vector2.left * lungeImpulse); }
            else { rb.AddForce(Vector2.right * lungeImpulse); }
        }
    }
    private bool lockLunge = false;
    internal int score;

    public void LungeLock()
    {
        lockLunge = false;
    }

    public void SavePlayer ()
    {
        SaveSystem.SavePlayer(this, scoreM, gun);
    }

    public void LoadPlayer ()
    {
        PlayerData data = SaveSystem.LoadPlayer();

        health = data.health;
        ScoreManager.score = data.score;

        Vector3 position;
        position.x = data.position[0];
        position.y = data.position[1];
        position.z = data.position[2];
        transform.position = position;
    }

    public void SwitchWeapon()
    {
        for (int i = 0; i < unlockedWeapons.Count; i++)
        {
            if(unlockedWeapons[i].activeInHierarchy)
            {
                unlockedWeapons[i].SetActive(false);
                if(i != 0)
                {
                    unlockedWeapons[i - 1].SetActive(true);
                    weaponIcon.sprite = unlockedWeapons[i - 1].GetComponent<SpriteRenderer>().sprite;
                }
                else
                {
                    unlockedWeapons[unlockedWeapons.Count - 1].SetActive(true);
                    weaponIcon.sprite = unlockedWeapons[unlockedWeapons.Count - 1].GetComponent<SpriteRenderer>().sprite;
                }
                weaponIcon.SetNativeSize();
                break;
            }
        }
    }

    void IgnoreLayerOff()
    {
        Physics2D.IgnoreLayerCollision(9, 10, false);
    }

    public void ReloadGun()
    {
        foreach(Gun g in guns)
        {
            if (g != null && g.gameObject.activeSelf && !g.isReloading)
            {
                if(Gun.allAmmo > 0)
                {
                    StartCoroutine(g.Reload());
                    
                }
            }
        }
    }

    public void SlavanskyZajim()
    {
        ScoreManager.score -= 200;
        anim.SetTrigger("СП1");
        PlaySound(0, p1: 1f, p2: 1f);
        Collider2D[] enemies = Physics2D.OverlapCircleAll(transform.position, SpZona);

        for (int i = 0; i < enemies.Length; i++)
        {
            Enemy enemy = enemies[i].GetComponent<Enemy>();
            if (enemy != null)
            {
                enemy.anim.SetTrigger("СП1");
            }
        }
    }
    private void OnDrawGizmosSelected()
    {
        Gizmos.color = Color.red;
        Gizmos.DrawWireSphere(SpPos.position, SpZona);
    }

    public void Stand()
    {
        seroga = true;
        ScoreManager.score -= 800;
        stend.SetActive(true);
    }

    public void Trasenie()
    {
        CamController.cameraShake?.Invoke(7f, 2f, 2f);
    }
}

